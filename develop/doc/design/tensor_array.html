

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Design for TensorArray &mdash; PaddlePaddle  documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="PaddlePaddle  documentation" href="../index.html"/> 

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/perfect-scrollbar/0.6.14/css/perfect-scrollbar.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/override.css" type="text/css" />
  <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?b9a314ab40d04d805655aab1deee08ba";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
  </script>

  

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  
  <header class="site-header">
    <div class="site-logo">
      <a href="/"><img src="../_static/images/PP_w.png"></a>
    </div>
    <div class="site-nav-links">
      <div class="site-menu">
        <a class="fork-on-github" href="https://github.com/PaddlePaddle/Paddle" target="_blank"><i class="fa fa-github"></i>Fork me on Github</a>
        <div class="language-switcher dropdown">
          <a type="button" data-toggle="dropdown">
            <span>English</span>
            <i class="fa fa-angle-up"></i>
            <i class="fa fa-angle-down"></i>
          </a>
          <ul class="dropdown-menu">
            <li><a href="/doc_cn">中文</a></li>
            <li><a href="/doc">English</a></li>
          </ul>
        </div>
        <ul class="site-page-links">
          <li><a href="/">Home</a></li>
        </ul>
      </div>
      <div class="doc-module">
        
        <ul>
<li class="toctree-l1"><a class="reference internal" href="../getstarted/index_en.html">GET STARTED</a></li>
<li class="toctree-l1"><a class="reference internal" href="../howto/index_en.html">HOW TO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index_en.html">API</a></li>
</ul>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>        
      </div>
    </div>
  </header>
  
  <div class="main-content-wrap">

    
    <nav class="doc-menu-vertical" role="navigation">
        
          
          <ul>
<li class="toctree-l1"><a class="reference internal" href="../getstarted/index_en.html">GET STARTED</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../getstarted/build_and_install/index_en.html">Install and Build</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getstarted/build_and_install/docker_install_en.html">PaddlePaddle in Docker Containers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getstarted/build_and_install/build_from_source_en.html">Installing from Sources</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../howto/index_en.html">HOW TO</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../howto/usage/cmd_parameter/index_en.html">Set Command-line Parameters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../howto/usage/cmd_parameter/use_case_en.html">Use Case</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howto/usage/cmd_parameter/arguments_en.html">Argument Outline</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howto/usage/cmd_parameter/detail_introduction_en.html">Detail Description</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../howto/usage/cluster/cluster_train_en.html">Run Distributed Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/usage/k8s/k8s_en.html">Paddle On Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/usage/k8s/k8s_aws_en.html">Distributed PaddlePaddle Training on AWS with Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/dev/build_en.html">Build PaddlePaddle from Source Code and Run Unit Test</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/dev/new_layer_en.html">Write New Layers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/dev/contribute_to_paddle_en.html">Contribute Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/deep_model/rnn/index_en.html">RNN Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../howto/deep_model/rnn/rnn_config_en.html">RNN Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../howto/optimization/gpu_profiling_en.html">Tune GPU Performance</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api/index_en.html">API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/v2/model_configs.html">Model Configuration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/v2/config/activation.html">Activation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/v2/config/layer.html">Layers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/v2/config/evaluators.html">Evaluators</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/v2/config/optimizer.html">Optimizer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/v2/config/pooling.html">Pooling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/v2/config/networks.html">Networks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/v2/config/attr.html">Parameter Attribute</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/v2/data.html">Data Reader Interface and DataSets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/v2/run_logic.html">Training and Inference</a></li>
</ul>
</li>
</ul>

        
    </nav>
    
    <section class="doc-content-wrap">

      

 







<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
      
    <li>Design for TensorArray</li>
  </ul>
</div>
      
      <div class="wy-nav-content" id="doc-content">
        <div class="rst-content">
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="design-for-tensorarray">
<span id="design-for-tensorarray"></span><h1>Design for TensorArray<a class="headerlink" href="#design-for-tensorarray" title="Permalink to this headline">¶</a></h1>
<p>TensorArray as a new concept is borrowed from TensorFlow,
it is meant to be used with dynamic iteration primitives such as <code class="docutils literal"><span class="pre">while_loop</span></code> and <code class="docutils literal"><span class="pre">map_fn</span></code>.</p>
<p>This concept can be used to support our new design of dynamic operations, and help to refactor some existing variant-sentence-related layers,
such as <code class="docutils literal"><span class="pre">RecurrentGradientMachine</span></code>.</p>
<p>In <a class="reference external" href="https://github.com/PaddlePaddle/Paddle/pull/4401">our design for dynamic RNN</a>,
<code class="docutils literal"><span class="pre">TensorArray</span></code> is used to segment inputs and store states in all time steps.
By providing some methods similar to a C++ array,
the definition of some state-based dynamic models such as RNN could be more natural and highly flexible.</p>
<div class="section" id="dynamic-related-methods">
<span id="dynamic-related-methods"></span><h2>Dynamic-Related Methods<a class="headerlink" href="#dynamic-related-methods" title="Permalink to this headline">¶</a></h2>
<p>Some basic methods should be proposed as follows:</p>
<div class="section" id="stack">
<span id="stack"></span><h3>stack()<a class="headerlink" href="#stack" title="Permalink to this headline">¶</a></h3>
<p>Pack the values in a <code class="docutils literal"><span class="pre">TensorArray</span></code> into a tensor with rank one higher than each tensor in <code class="docutils literal"><span class="pre">values</span></code>.</p>
</div>
<div class="section" id="unstack-axis-0">
<span id="unstack-axis-0"></span><h3>unstack(axis=0)<a class="headerlink" href="#unstack-axis-0" title="Permalink to this headline">¶</a></h3>
<p>Unpacks the given dimension of a rank-<code class="docutils literal"><span class="pre">R</span></code> tensor into rank-<code class="docutils literal"><span class="pre">(R-1)</span></code> tensors.</p>
</div>
<div class="section" id="concat">
<span id="concat"></span><h3>concat()<a class="headerlink" href="#concat" title="Permalink to this headline">¶</a></h3>
<p>Return the values in the <code class="docutils literal"><span class="pre">TensorArray</span></code> as a concatenated Tensor.</p>
</div>
<div class="section" id="write-index-value-data-shared-true">
<span id="write-index-value-data-shared-true"></span><h3>write(index, value, data_shared=true)<a class="headerlink" href="#write-index-value-data-shared-true" title="Permalink to this headline">¶</a></h3>
<p>Write value into index of the TensorArray.</p>
</div>
<div class="section" id="read-index">
<span id="read-index"></span><h3>read(index)<a class="headerlink" href="#read-index" title="Permalink to this headline">¶</a></h3>
<p>Read the value at location <code class="docutils literal"><span class="pre">index</span></code> in the <code class="docutils literal"><span class="pre">TensorArray</span></code>.</p>
</div>
<div class="section" id="size">
<span id="size"></span><h3>size()<a class="headerlink" href="#size" title="Permalink to this headline">¶</a></h3>
<p>Return the number of values.</p>
</div>
</div>
<div class="section" id="lodtensor-related-supports">
<span id="lodtensor-related-supports"></span><h2>LoDTensor-related Supports<a class="headerlink" href="#lodtensor-related-supports" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">RecurrentGradientMachine</span></code> in Paddle serves as a flexible RNN layer; it takes variant length sequences as input,
because each step of RNN could only take a tensor-represented batch of data as input,
some preprocess should be taken on the inputs such as sorting the sentences by their length in descending order and cut each word and pack to new batches.</p>
<p>Such cut-like operations can be embedded into <code class="docutils literal"><span class="pre">TensorArray</span></code> as general methods called <code class="docutils literal"><span class="pre">unpack</span></code> and <code class="docutils literal"><span class="pre">pack</span></code>.</p>
<p>With these two methods, a variant-sentence-RNN can be implemented like</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="c1">// input is the varient-length data</span>
<span class="n">LodTensor</span> <span class="nf">sentence_input</span><span class="p">(</span><span class="n">xxx</span><span class="p">);</span>
<span class="n">TensorArray</span> <span class="n">ta</span><span class="p">;</span>
<span class="n">Tensor</span> <span class="n">indice_map</span><span class="p">;</span>
<span class="n">Tensor</span> <span class="n">boot_state</span> <span class="o">=</span> <span class="n">xxx</span><span class="p">;</span> <span class="c1">// to initialize rnn&#39;s first state</span>
<span class="n">TensorArray</span><span class="o">::</span><span class="n">unpack</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="mi">1</span><span class="cm">/*level*/</span><span class="p">,</span> <span class="nb">true</span><span class="cm">/*sort_by_length*/</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">indice_map</span><span class="p">);</span>
<span class="n">TessorArray</span> <span class="n">step_outputs</span><span class="p">;</span>
<span class="n">TensorArray</span> <span class="n">states</span><span class="p">;</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">step</span> <span class="o">=</span> <span class="n">ta</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">step</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">state</span> <span class="o">=</span> <span class="n">states</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">step</span><span class="p">);</span>
  <span class="c1">// rnnstep is a function which acts like a step of RNN</span>
  <span class="k">auto</span> <span class="n">step_input</span> <span class="o">=</span> <span class="n">ta</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">step</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">step_output</span> <span class="o">=</span> <span class="n">rnnstep</span><span class="p">(</span><span class="n">step_input</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
  <span class="n">step_outputs</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">step_output</span><span class="p">,</span> <span class="nb">true</span><span class="cm">/*data_shared*/</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// rnn_output is the final output of an rnn</span>
<span class="n">LoDTensor</span> <span class="n">rnn_output</span> <span class="o">=</span> <span class="n">ta</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">ta</span><span class="p">,</span> <span class="n">indice_map</span><span class="p">);</span>
</pre></div>
</div>
<p>the code above shows that by embedding the LoDTensor-related preprocess operations into <code class="docutils literal"><span class="pre">TensorArray</span></code>,
the implementation of a RNN that supports varient-length sentences is far more concise than <code class="docutils literal"><span class="pre">RecurrentGradientMachine</span></code> because the latter mixes all the codes together, hard to read and extend.</p>
<p>some details are as follows.</p>
<div class="section" id="unpack-level-sort-by-length">
<span id="unpack-level-sort-by-length"></span><h3>unpack(level, sort_by_length)<a class="headerlink" href="#unpack-level-sort-by-length" title="Permalink to this headline">¶</a></h3>
<p>Split LodTensor in some <code class="docutils literal"><span class="pre">level</span></code> and generate batches, if set <code class="docutils literal"><span class="pre">sort_by_length</span></code>, will sort by length.</p>
<p>Returns:</p>
<ul class="simple">
<li>a new <code class="docutils literal"><span class="pre">TensorArray</span></code>, whose values are LodTensors and represents batches of data.</li>
<li>an int32 Tensor, which stores the map from the new batch&#8217;s indices to original LoDTensor</li>
</ul>
</div>
<div class="section" id="pack-level-indices-map">
<span id="pack-level-indices-map"></span><h3>pack(level, indices_map)<a class="headerlink" href="#pack-level-indices-map" title="Permalink to this headline">¶</a></h3>
<p>Recover the original LoD-arranged LoDTensor with the values in a <code class="docutils literal"><span class="pre">TensorArray</span></code> and <code class="docutils literal"><span class="pre">level</span></code> and <code class="docutils literal"><span class="pre">indices_map</span></code>.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, PaddlePaddle developers.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: ".txt",
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
       
  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  
  
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/perfect-scrollbar/0.6.14/js/perfect-scrollbar.jquery.min.js"></script>
  <script src="../_static/js/paddle_doc_init.js"></script> 

</body>
</html>